<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Case-1 FINAL PROOF ‚Äì Browser-Only LLM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #020617;
  color: #e5e7eb;
  padding: 20px;
}
button {
  padding: 12px 18px;
  font-size: 16px;
  cursor: pointer;
}
#state {
  margin-top: 12px;
  font-weight: bold;
}
pre {
  background: #020617;
  border: 1px solid #1e293b;
  padding: 10px;
  margin-top: 15px;
  max-height: 320px;
  overflow-y: auto;
  font-size: 13px;
}
.fail {
  color: #ef4444;
}
.ok {
  color: #22c55e;
}
</style>
</head>

<body>

<h2>üß™ Case-1: Browser-Only LLM (FINAL PROOF)</h2>

<button id="btn">Load Local LLM</button>

<div id="state">Idle</div>
<pre id="log"></pre>

<script type="module">
/* ============================================================
   VISUAL LOGGING (NO DEVTOOLS REQUIRED)
============================================================ */
const logBox = document.getElementById("log");
const stateBox = document.getElementById("state");
const btn = document.getElementById("btn");

function log(msg) {
  logBox.textContent += msg + "\n";
  logBox.scrollTop = logBox.scrollHeight;
}
function state(msg, cls="") {
  stateBox.textContent = msg;
  stateBox.className = cls;
  log("STATE ‚Üí " + msg);
}

/* ============================================================
   GLOBAL TRAPS (CATCH HARD FAILURES)
============================================================ */
window.onerror = (msg) => {
  state("JS Runtime Error", "fail");
  log("window.onerror ‚Üí " + msg);
};
window.onunhandledrejection = (e) => {
  state("Unhandled Promise Rejection", "fail");
  log("unhandledrejection ‚Üí " + e.reason);
};

/* ============================================================
   HEARTBEAT (PROVES JS IS ALIVE)
============================================================ */
let heartbeatId = null;
function startHeartbeat() {
  let n = 0;
  heartbeatId = setInterval(() => {
    n++;
    log("Heartbeat " + n);
  }, 500);
}
function stopHeartbeat() {
  clearInterval(heartbeatId);
}

/* ============================================================
   MAIN TEST
============================================================ */
btn.onclick = async () => {
  btn.disabled = true;
  state("Button clicked");
  log("Click registered");

  startHeartbeat();

  try {
    // Force UI repaint
    await new Promise(r => setTimeout(r, 100));

    state("Importing Transformers.js‚Ä¶");
    log("Before dynamic import");

    const { pipeline, env } =
      await import("https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2");

    state("Transformers imported");

    /* ---------- SAFEST POSSIBLE SETTINGS ---------- */
    env.allowLocalModels = false;
    env.useBrowserCache = true;
    env.backends.webgpu.enabled = false;
    env.backends.wasm.enabled = true;
    env.backends.onnx.wasm.numThreads = 1;

    await new Promise(r => setTimeout(r, 100));
    state("Creating pipeline‚Ä¶");
    log("Before pipeline() call");

    /* ---------- SMALLEST VIABLE MODEL ---------- */
    const generator = await pipeline(
      "text-generation",
      "Xenova/tiny-random-LlamaForCausalLM",
      { device: "cpu" }
    );

    stopHeartbeat();
    state("‚úÖ Model Loaded", "ok");

    log("Running inference‚Ä¶");

    const out = await generator("Hello", { max_new_tokens: 10 });
    log("Output ‚Üí " + JSON.stringify(out));

    state("üéâ Case-1 WORKED (extremely rare)", "ok");

  } catch (e) {
    stopHeartbeat();
    state("‚ùå Failed", "fail");
    log("Caught Error ‚Üí " + (e.message || e));
  } finally {
    btn.disabled = false;
  }
};
</script>

</body>
</html>
